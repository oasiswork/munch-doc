<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">

        <title>Api - MunchMail, guide du développeur</title>

        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link href="../css/prettify-1.0.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <!-- Main title -->
            <a class="navbar-brand" href="..">MunchMail, guide du développeur</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            
            
                <li >
                    <a href="../annexes/">Annexes</a>
                </li>
            
            
            
                <li class="active">
                    <a href="./">Api</a>
                </li>
            
            
            
                <li >
                    <a href="../faq/">Faq</a>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Exemples <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../exemples/php/">Php</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                
                <li >
                    <a rel="next" href="../annexes/">
                        <i class="fa fa-arrow-left"></i> Previous
                    </a>
                </li>
                <li >
                    <a rel="prev" href="../faq/">
                        Next <i class="fa fa-arrow-right"></i>
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#lapi">L'API</a></li>
        
            <li><a href="#points-notables">Points notables</a></li>
        
            <li><a href="#authentification">Authentification</a></li>
        
            <li><a href="#instance-de-demonstration">Instance de démonstration</a></li>
        
            <li><a href="#une-campagne-de-a-a-z">Une campagne de A à Z</a></li>
        
    
    </ul>
</div></div>
            <div class="col-md-9" role="main">

<h1 id="lapi">L'API</h1>
<p>L'API est accessible à l'adresse <em>https://api.demo.munchmailer.fr</em>. Elle
requiert une authentification pour fonctionner.</p>
<p>Elle suit les principes
<a href="http://fr.wikipedia.org/wiki/Representational_State_Transfer">HTTP/REST</a>, et utilise
le format <a href="http://fr.wikipedia.org/wiki/JavaScript_Object_Notation">JSON</a>, ce
qui la rend exploitable depuis un grand nombre de langages de programmation.</p>
<p>Les étapes de la vie d'une campagne sont :</p>
<ol>
<li>Création/édition de la campagne avec ses attributs</li>
<li>Ajout/modification d'une liste de destinataires</li>
<li>Ajout/modification (et prévisualisation) du message</li>
<li>Validation de la campagne (envoi)</li>
<li>Suivi des envois</li>
</ol>
<p>Les étapes 2 et 3 peuvent être interverties ; de même, tant que la campagne
n'est pas validée, elle peut-être modifiée (1.).</p>
<h2 id="points-notables">Points notables</h2>
<ul>
<li>Les urls des objets (rappelés dans des attributs JSON <strong>url</strong>) sont
  l'identifiant unique d'un objet dans le système. Elles peuvent-être
  utilisées à la fois pour consulter l'objet (requête <code>GET</code>) ou le modifier
  (requête <code>PUT</code>).</li>
<li>L'API est <em>explorable</em> : en vous rendant sur https://api.demo.munchmailer.fr,
  vous avez une version graphique de l'API que vous pouvez utiliser
  directement depuis le navigateur pour découvrir ou débuguer par exemple.</li>
<li>Si accédée depuis un client <code>HTTP</code> ne présentant pas de <code>Content-type</code> (ex:
  <em>php5-curl</em>), l'API dialogue par défaut en JSON.</li>
</ul>
<h2 id="authentification">Authentification</h2>
<p>L'authentification de cette API s'appuie sur SSL, ce qui offre une manière
standard les fonctionalités suivantes :</p>
<ul>
<li>Nous <strong>authentifions votre application</strong> (<em>certificat client</em>)</li>
<li>Votre application <strong>authentifie notre serveur</strong> (<em>certificat serveur</em>)</li>
<li>Le traffic entre votre application et notre serveur est <strong>chiffré</strong></li>
</ul>
<p>Référez-vous à la documentation de votre langage de programmation pour savoir
comment utiliser un certificat client (tous les langages courants le proposent,
sans installation de bibliothèque supplémentaire).</p>
<p>L'authentification est abordée notamment dans nos
<a href="/exemples/php/">exemples pour PHP</a>.</p>
<h2 id="instance-de-demonstration">Instance de démonstration</h2>
<p>Durant la phase de tests et de développement de votre application, nous vous
encourageons à utiliser l'instance publique de démonstration :</p>
<p><strong><a href="https://api.demo.munchmail.net">https://api.demo.munchmail.net</a></strong></p>
<p>Il est identique au serveur de production, mais :</p>
<ul>
<li>Il n'envoie pas réellement les mails</li>
<li>Il est effacé périodiquement</li>
</ul>
<p>Pour l'authentification de l'instance de démonstration :</p>
<ul>
<li>Fichier de CA : <a href="/files/ssl/demo-ca.pem">demo-ca.pem</a></li>
<li>Certificat client : <a href="/files/ssl/demo-client-cert.pem">demo-client-cert.pem</a></li>
<li>Mot de passe : <code>OHc9HS7qOynty8LiH5tNV0qKX</code></li>
</ul>
<h2 id="une-campagne-de-a-a-z">Une campagne de A à Z</h2>
<h3 id="1-creationedition-de-la-campagne-avec-ses-attributs">1. Création/édition de la campagne avec ses attributs</h3>
<pre class="prettyprint well"><code>POST /api/v1/campaigns/
{
    "name"         :"Newsletter de Juillet",
    "sender_email" :"newsletter@example.com",
    "sender_name"  :"Communication ACME chaussures",
    "tech_contacts":"admins@example.com, communication@example.com",
    "owners"       :"communication@example.com"
}
</code></pre>
<ul>
<li><strong>name</strong> : Le nom interne donné à la campagne, il ne sera pas visible de vos
   destinataires.</li>
<li><strong>sender_email</strong> : le mail d'expéditeur de la campagne, vous devez être
   propriétaire du domaine concerné (ici <em>example.com</em>), et en y avoir
   <a href="">correctement configuré SPF et DKIM</a>.</li>
<li><strong>sender_name</strong> : le nom de l'expéditeur, qui apparaîtra dans le client mail de
   vos destinataires.</li>
<li><strong>tech_contacts</strong> : liste d'emails, séparées par des virgules, ils recevront
   notamment les notifications de résiliation</li>
<li><strong>owners</strong> : liste d'emails, séparées par des virgules, FIXME</li>
</ul>
<p>Si tout se passe bien, l'API devrait vous retourner :</p>
<pre class="prettyprint well"><code>HTTP 201 CREATED
{
    "customer": 1024,
    "message": "https://api.demo.munchmailer.fr/api/v1/campaigns/6/message/",
    "mails": "http://localhost:8000/api/v1/campaigns/6/mails/",
    "completion_date": null,
    "preview": "https://api.demo.munchmailer.fr/api/v1/campaigns/6/preview/",
    "url": "http://localhost:8000/api/v1/campaigns/6/",
    "name": "Newsletter de Juillet",
    "status": "new",
    "sender_email": "newsletter@example.com",
    "sender_name": "Newsletter ACME chaussures",
    "creation_date": "2014-08-27T14:55:58.470Z",
    "send_date": null,
    "owners": "communication@example.com",
    "tech_contacts": "admins@example.com,communication@example.com",
    "external_optout": false
}
</code></pre>
<p>Notons quelques champs :</p>
<ul>
<li><strong>url</strong> est à conserver, elle vous permet d'accéder à votre campagne pour la
   visualiser ou la modifier.</li>
<li><strong>status</strong> nous donne l'état courant de la campagne</li>
<li><strong>message</strong> est un lien vers le message de la campagne (voir <a href="">étape 3.</a>)</li>
<li><strong>mails</strong> est un lien vers la liste des destinataires et leur état courant (voir
   <a href="">étape 2</a>)</li>
<li><strong>preview</strong> Permet de voir un résumé de la campagne, utile notamment avant de
   <a href="">valider la campagne</a></li>
</ul>
<p>En cas d'erreur, vous recevrez une erreur 400 détaillant l'erreur, qui peuvent
notamment concerner les enregistrements <a href="">DKIM</a> ou <a href="">SPF</a></p>
<pre class="prettyprint well"><code>HTTP 400 BAD REQUEST
{
    "sender_email": [
        "Le champ SPF pour example.com est mal configur\u00e9",
        "Pas de configuration DKIM pour le domaine example.com"
    ]
}
</code></pre>
<p>En cas d'erreur de validation, <strong>la campagne n'est pas créée</strong>.</p>
<p>Pour <em>modifier</em> la campagne, il faut effectuer une requête de type <code>PUT</code> à
l'adresse retournée dans l'attribut <strong>url</strong> en envoyant la totalité du contenu
de l'objet, modifié comme souhaité.</p>
<h3 id="2-ajoutmodification-dune-liste-de-destinataires">2. Ajout/modification d'une liste de destinataires</h3>
<p>Il est possible d'ajouter des destinataires soit un par un, soit en lots :</p>
<p>(on utilise l'adresse contenue dans l'attribut <strong>message</strong> de notre objet, voir
étape précédente).</p>
<h4 id="ajout-des-destinataires-un-par-un">Ajout des destinataires un par un</h4>
<p>Il suffit de faire autant de requêtes POST que de destinataires à ajouter.</p>
<pre class="prettyprint well"><code>POST /api/v1/campaigns/6/mails/
{
    "to" : "mon-destinataire@domaine.tld"
}
</code></pre>
<h4 id="ajout-des-destinataires-par-lot">Ajout des destinataires par lot</h4>
<pre class="prettyprint well"><code>POST /api/v1/campaigns/6/mails/
[
    {"to" : "john@domaine.tld"},
    {"to" : "jane@domaine.tld"},
    {"to" : "fox@autredomaine.tld"},
]
</code></pre>
<p>Que vous ajoutiez les destinataires individuellement ou en lot, vous recevrez
les statuts HTTP suivants :</p>
<ul>
<li><strong>201 (created)</strong> si tout se passe bien</li>
<li><strong>400 (bad request)</strong> si l'email est invalide (adresse mal formée ou domaine
non habilité à recevoir du courriel)</li>
</ul>
<p>Par exemple…</p>
<pre class="prettyprint well"><code> POST /api/v1/campaigns/6/mails/
 {
    "to" : "jenesuispasunemail"
 }
</code></pre>
<p>… retournera</p>
<pre class="prettyprint well"><code>400 BAD REQUEST
{
    "to": [
       "Saisissez une adresse de courriel valide."
    ]
}
</code></pre>
<h3 id="3-ajoutmodification-et-previsualisation-du-message">3. Ajout/modification (et prévisualisation) du message</h3>
<p>C'est le point le plus crucial de votre campagne.</p>
<p>Si la méthode qui donne les meilleurs résultats est de rédiger ce document HTML
à la main, il peut également être produit avec un éditeur WYSIWYG, un traitement
de texte… etc.</p>
<p>Pour des conseils sur la rédaction de mails en HTML, vous pouvez vous référer à
<a href="http://kb.mailchimp.com/article/how-to-code-html-emails/">ce guide</a> ou encore
<a href="https://github.com/mailchimp/Email-Blueprints">ce dépôt d'exemples</a>.</p>
<p>Niveau API, on défini le message de notre campagne d'exemple de la manière
suivante :</p>
<pre class="prettyprint well"><code>PUT /api/v1/campaigns/1/message/
{
   "subject": "Tu peux faire tout ce que tu veux",
   "html": "&lt;h1&gt;Mais ne marche pas sur mes chaussures en suédine bleue&lt;/h1&gt;"
}
</code></pre>
<ul>
<li><strong>subject</strong> est le sujet de l'email</li>
<li><strong>html</strong> est le corps du message, en HTML</li>
</ul>
<p>Le message fourni dans le paramètre <strong>html</strong> fera l'objet de plusieurs traitements :</p>
<ul>
<li>Un « nettoyage » pour apparaître au mieux sur tous les clients mail (voir
  <a href="">liste des traitements appliqués</a>)</li>
<li>La génération d'une version « texte brut » à partir de ce dernier, fourni en
  tant qu'alternative (il est nécessaire de fournir une version texte brut
  dans les emails).</li>
<li>Un test anti-spam, pour vérifier qu'il ne risque pas d'être considéré comme
  spam.</li>
</ul>
<p>La réponse à notre requête PUT ressemblerait à :</p>
<pre class="prettyprint well"><code>HTTP 201 CREATED
{
    "url": "https://api.demo.munchmailer.fr/api/v1/campaigns/1/message/",
    "subject": "Tu peux faire tout ce que tu veux",
    "html": "&lt;h1&gt;Mais ne marche pas sur mes chaussures en su\u00e9dine bleue&lt;/h1&gt;",
    "is_spam": false,
    "spam_score": 0.0,
    "spam_details": "https://api.demo.munchmailer.fr/api/v1/campaigns/1/message/spam_details/",
    "preview": "http://localhost:8000/api/v1/campaigns/1/message/preview/",
    "html_preview": "https://api.demo.munchmailer.fr/api/v1/campaigns/1/message/preview/.html",
    "plaintext_preview": "http://localhost:8000/api/v1/campaigns/1/message/preview/.txt"
}
</code></pre>
<ul>
<li><strong>is_spam</strong> devrait vous alerter si il est à <code>true</code> (viser le zéro de
    <strong>spam_score</strong> peut-être un bon objectif), le système refusera quoi qu'il en
    <strong>soit d'envoyer un </strong>message considéré comme spam ;</li>
<li><strong>spam_details</strong> permet d'accéder au barème détaillé du <em>spam_score</em>, afin de
    pouvoir apporter les modifications nécessaires au contenu de <strong>html</strong>.</li>
<li><strong>preview</strong>, <strong>html_preview</strong> et <strong>plaintext_preview</strong> permettent d'avoir une
    idée du code et du rendu du mail une fois « nettoyé » par MunchMailer.</li>
</ul>
<h3 id="4-validation-de-la-campagne-envoi">4. Validation de la campagne (envoi)</h3>
<p>Tout est prêt, la campagne n'est pas considérée comme spam, le département de
communication est aux anges, il est temps de démarrer l'envoi de la campagne.</p>
<p>Une dernière vue de validation est offerte (mentionnée dans l'objet <em>campagne</em>,
attribut <strong>preview</strong>) (cf <a href="">étape 1.</a>).</p>
<p>Par exemple…</p>
<pre class="prettyprint well"><code>GET /api/v1/campaigns/1/preview/
</code></pre>
<p>… retourne :</p>
<pre class="prettyprint well"><code>HTTP 200 OK
{
    "recipients": [
        "mon-destinataire@domaine.tld",
        "john@domaine.tld",
        "fox@autre-domaine.tld"
    ],
    "excluded_recipients": [
        "jane@domaine.tld",
    ],
    "spam_score": 0.0,
    "is_spam": false,
    "html_message": "&lt;div&gt;&lt;body&gt;&lt;h1&gt;Mais ne marche pas sur mes chaussures en su\u00e9dine bleue&lt;/h1&gt;&lt;p style=\"font-size: small\"&gt;&lt;a href=\"UNSUBSCRIBE_URL\"&gt;Se d\u00e9sinscrire&lt;/a&gt; pour ne plus recevoir ces emails&lt;/p&gt;&lt;/body&gt;&lt;/div&gt;",
    "plaintext_message": "# Mais ne marche pas sur mes chaussures en su\u00e9dine bleue\n\n[Se d\u00e9sinscrire][1] pour ne plus recevoir ces emails\n\n   [1]: UNSUBSCRIBE_URL\n\n"
}
</code></pre>
<p>Les informations de spam sont les mêmes qu'à l'étape précédente, ainsi que la
prévisualisation.</p>
<ul>
<li><strong>recipients</strong> et <strong>excluded_recipients</strong> se partagent les destinataires que
    vous avez définis à l'<a href="">étape 2.</a>, dans excluded_recipients sont listés les
    destinataires auxquels la campagne ne sera pas envoyée pour des raisons de
    désinscription (<a href="">résiliation</a>) de leur part ou des raisons techniques (<a href="">bounces</a>).</li>
</ul>
<p>Pour avoir le détail des résiliation, se référer à l'étape suivante.</p>
<p>Une fois que tout semble bon, il n'y a qu'à changer l'attribut <strong>status</strong> de la
campagne à sending à l'aide d'une requête <code>PUT</code> (en passant tous les attributs
de la campagne) ou <code>PATCH</code> (en ne passant que l'attribut <em>status</em>):</p>
<pre class="prettyprint well"><code>PATCH /api/v1/campaigns/1/
{
    "status"       :"sending"
}
</code></pre>
<p>Si tout va bien, l'API retourne un <code>200 OK</code>.</p>
<p>Les mails commencent à-partir de ce moment à être envoyés aux destinataires.</p>
<h3 id="5-suivi-des-envois">5. Suivi des envois</h3>
<h4 id="suivi-des-emails">Suivi des emails</h4>
<p>Vous pouvez avoir tous les emails en cours d'acheminement et utilisant
l'attribut <code>mails</code> de la campagne. Par exemple :</p>
<pre class="prettyprint well"><code>GET https://api.demo.munchmailer.fr/api/v1/campaigns/6/mails/"
[
{
    "to": "jane@domain.tld",
    "date": "2014-08-05T12:44:28.556Z",
    "last_status": {
        "status": "sent",
        "date": "2014-08-05T12:59:11Z",
        "raw_msg": "Accepted by local MTA"
    }
},
{
    "to": john@domain.tld",
    "date": "2014-07-25T08:52:34.261Z",
    "last_status": {
        "status": "delivered",
        "date": "2014-07-25T12:07:49Z",
        "raw_msg": Delivered to remote server"
    }
},
{
    "to": "mon-destinataire@domaine.tld",
    "date": "2014-07-30T08:40:56Z",
    "last_status": {
        "status": "hardbounced",
        "date": "2014-07-30T08:41:44Z",
        "raw_msg": "recipient mon-destinataire@domain.tld do not exist"
    }
}
]
</code></pre>
<p>Les différents statuts possibles sont :</p>
<ul>
<li><strong>unknown</strong> : le message n'est pas encore entré dans
    l'infrastructure mail</li>
<li><strong>sent</strong> : le message a été accepté par les serveurs d'oasiswork est en cours
    d'acheminement</li>
<li><strong>delivered</strong> : le message a été remis au serveur du destinataire</li>
<li><strong>softbounced</strong> : le message a été rejeté à chaque tentative  pour
    <em>soft-bounce</em>, il n'a pu être remis.</li>
<li><strong>hardbounced</strong> : le message a été rejeté net par le serveur distant
    (hard-bounce).</li>
</ul>
<h4 id="suivi-des-resiliations">Suivi des résiliations</h4>
<p>Les contacts techniques sont notifiés par email à chaque résiliation.</p>
<p>Par ailleurs, il est possible de consulter les résiliations via l'API ; si votre
identifiant de client est le 42 :</p>
<pre class="prettyprint well"><code>GET /api/v1/customers/42/opt-outs/

[
{
    "address": "jane-blacklist@example.com",
    "date": "2014-08-08T14:54:35Z",
    "origin": "mail"
},
{
    "address": "john-greylist@example.com",
    "date": "2014-08-08T14:55:16Z",
    "origin": "feedback-loop"
},
]
</code></pre>
<p>Le champ <strong>origin</strong> contient la raison de la désinscription, qui peut-être
automatique ou bien volontaire de la part de l'utilisateur ; il peut contenir
les valeurs suivantes:</p>
<ul>
<li><strong>mail</strong> Un mail de désinscription a été envoyé à l'adresse <code>List-Unsubscribe</code>
    mentionnée dans un mail reçu par un de vos destinataires ;</li>
<li><strong>web</strong> Un destinataire a utilisé le formulaire du lien inséré en bas de
    l'email pour se désinscrire</li>
<li><strong>feedback-loop</strong> Le destinataire a marqué un de vos messages comme spam, et
    son hébergeur nous a remonté l'information</li>
<li><strong>bounce</strong> L'adresse du destinataire a produit trop d'erreurs de livraisons
    (ex: boite pleine, adresse inexistante…)</li>
<li><strong>abuse</strong> Le destinataire a signalé le message comme étant un abus</li>
</ul>
<p>Si vous recevez de nombreuses désinscriptions de type <strong>abuse</strong>, il faut vous
poser des question sur la légitimité de votre liste de
contacts. <strong>N'utilisez-pas de liste de mails achetées</strong>… et respectez la
législation en vigueur.</p>
</div>
        </div>

        

        <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
        <script src="../js/bootstrap-3.0.3.min.js"></script>
        <script src="../js/prettify-1.0.min.js"></script>
        <script src="../js/base.js"></script>
    </body>
</html>
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">

        <title>Tutoriel : un envoi de A à Z - MunchMail</title>

        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link href="../../css/prettify-1.0.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <!-- Main title -->
            <a class="navbar-brand" href="../..">MunchMail</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            
            
                <li >
                    <a href="../..">Guide du développeur</a>
                </li>
            
            
            
                <li class="dropdown active">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">L'API <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../intro/">Introduction</a>
                        </li>
                    
                        <li >
                            <a href="../auth/">Authentification</a>
                        </li>
                    
                        <li class="active">
                            <a href="./">Tutoriel : un envoi de A à Z</a>
                        </li>
                    
                        <li >
                            <a href="../campagnes/">Campagnes</a>
                        </li>
                    
                        <li >
                            <a href="../domaines/">Domaines</a>
                        </li>
                    
                        <li >
                            <a href="../tracking/">Suivi des actions côté destinataire</a>
                        </li>
                    
                        <li >
                            <a href="../stats/">Statistiques</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Exemples de code <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../../exemples/php/">PHP</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li >
                    <a href="../../faq/">FAQ</a>
                </li>
            
            
            
                <li >
                    <a href="../../annexes/">Annexes</a>
                </li>
            
            
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                
                <li >
                    <a rel="next" href="../auth/">
                        <i class="fa fa-arrow-left"></i> Previous
                    </a>
                </li>
                <li >
                    <a rel="prev" href="../campagnes/">
                        Next <i class="fa fa-arrow-right"></i>
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#tutoriel-un-envoi-de-a-a-z">Tutoriel : Un envoi de A à Z</a></li>
        
            <li><a href="#1-creationedition-dun-message-avec-ses-attributs">1. Création/édition d'un message avec ses attributs</a></li>
        
            <li><a href="#2-ajoutmodification-dune-liste-de-destinataires">2. Ajout/modification d'une liste de destinataires</a></li>
        
            <li><a href="#3-previsualisation-et-envoi-a-quelques-destinataires-pilotes">3. Prévisualisation et envoi à quelques destinataires « pilotes »</a></li>
        
            <li><a href="#4-declenchement-de-lenvoi">4. Déclenchement de l'envoi</a></li>
        
            <li><a href="#5-suivi-des-envois">5. Suivi des envois</a></li>
        
    
    </ul>
</div></div>
            <div class="col-md-9" role="main">

<h1 id="tutoriel-un-envoi-de-a-a-z">Tutoriel : Un envoi de A à Z</h1>
<p>Les étapes de la vie d'une campagne sont :</p>
<ol>
<li>Création/édition d'un message avec ses attributs</li>
<li>Ajout/modification d'une liste de destinataires</li>
<li>Prévisualisation et envoi à quelques destinataires « pilotes »</li>
<li>Déclenchement de l'envoi</li>
<li>Suivi des envois</li>
</ol>
<h2 id="1-creationedition-dun-message-avec-ses-attributs">1. Création/édition d'un message avec ses attributs</h2>
<pre class="prettyprint well"><code>POST /api/v1/messages/
{
    "name"         :"Newsletter de Juillet",
    "sender_email" :"newsletter@example.com",
    "sender_name"  :"Communication ACME chaussures",
    "subject": "Tu peux faire tout ce que tu veux",
    "html": "&lt;h1&gt;Mais ne marche pas sur mes chaussures en suédine bleue&lt;/h1&gt;"
}
</code></pre>
<ul>
<li><strong>name</strong> : Le nom interne donné à la campagne, il ne sera pas visible de vos
   destinataires.</li>
<li><strong>sender_email</strong> : le mail d'expéditeur de la campagne, le domaine de cette
    adresse doit préalablement avoir été <a href="../domaines/">configuré correctement</a>.</li>
<li><strong>sender_name</strong> : le nom de l'expéditeur, qui apparaîtra dans le client mail de
   vos destinataires.</li>
<li><strong>subject</strong> : Le sujet de votre email.</li>
<li><strong>html</strong> : Le corps en HTML de votre email.</li>
</ul>
<hr />
<p><em>Des <a href="tracking">options de suivi</a> des messages sont également disponibles.</em></p>
<hr />
<p>Le message fourni dans le paramètre <strong>html</strong> fera l'objet de plusieurs
traitements :</p>
<ul>
<li>Un « nettoyage » pour apparaître au mieux sur tous les clients mail (voir
  <a href="/annexes/#details-des-modifications-appliquees-aux-emails">liste des traitements appliqués</a>)</li>
<li>La génération d'une version « texte brut » à partir de ce dernier, fourni en
  tant qu'alternative (il est nécessaire de fournir une version texte brut
  dans les emails).</li>
<li>Un test anti-spam, pour vérifier qu'il ne risque pas d'être considéré comme
  spam.</li>
</ul>
<hr />
<p><em>ⓘ Facultativement, un message peut-être rattaché à une campagne, ce
point est traité dans la <a href="../campagnes/">section dédiée de la documentation</a>.</em></p>
<hr />
<p>Si tout se passe bien, l'API devrait vous retourner :</p>
<pre class="prettyprint well"><code>HTTP 201 CREATED
{
    "url": "https://api.munchmail.net/api/v1/messages/4/",
    "name": "ACME − Newsletter Juillet",
    "sender_email": "newsletter@example.com",
    "sender_name": "Communication ACME chaussures",
    "subject": "Tu peux faire tout ce que tu veux",
    "html": "&lt;h1&gt;Mais ne marche pas sur mes chaussures en suédine bleue&lt;/h1&gt;"
    "status": "message_ok",
    "campaign": null,
    "creation_date": "2015-01-12T15:37:29.803Z",
    "send_date": null,
    "completion_date": null,
    "external_optout": false,
    "detach_images": false,
    "spam_score": 0.0,
    "is_spam": false,
    "msg_issue": "",
    "_links": {
        "preview_send": {
            "href": "https://api.munchmail.net/api/v1/messages/4/preview_send/"
        },
        "preview": {
            "href": "https://api.munchmail.net/api/v1/messages/4/preview/"
        },
        "preview/.html": {
            "href": "https://api.munchmail.net/api/v1/messages/4/preview/.html/"
        },
        "preview/.txt": {
            "href": "https://api.munchmail.net/api/v1/messages/4/preview/.txt/"
        },
        "mails": {
            "href": "https://api.munchmail.net/api/v1/messages/4/mails/"
        },
        "spam_details": {
            "href": "https://api.munchmail.net/api/v1/messages/4/spam_details/"
        }
    }
}
</code></pre>
<p>Notons quelques champs :</p>
<ul>
<li><strong>url</strong> est à conserver, elle vous permet d'accéder à votre message pour la
   visualiser ou la modifier.</li>
<li><strong>status</strong> nous donne l'état courant du message</li>
<li><strong>mails</strong> est un lien vers la liste des destinataires et leur état courant (voir
   <a href="#2-ajoutmodification-dune-liste-de-destinataires">étape 2</a>)</li>
<li><strong>preview</strong> Permet de voir un résumé du message ; utile notamment avant de
   <a href="#4-validation-du-message">valider le message</a></li>
<li><strong>is_spam</strong> devrait vous alerter si il est à <code>true</code> (viser le zéro de
    <strong>spam_score</strong> peut-être un bon objectif), le système <strong>refusera quoi qu'il
    en soit d'envoyer</strong> un message considéré comme spam ;</li>
<li><strong>spam_details</strong> permet d'accéder au barème détaillé du <em>spam_score</em>, afin de
    pouvoir apporter les modifications nécessaires au contenu de <strong>html</strong>.</li>
<li><strong>preview</strong>, <strong>html_preview</strong> et <strong>plaintext_preview</strong> permettent d'avoir une
    idée du code et du rendu du mail une fois « nettoyé » par MunchMail (voir <a href="#previsualisation">Prévisualisation</a>)</li>
<li><strong>preview_send</strong> Permet d'envoyer le message à quelques destinataires de test
    (voir <a href="#envoi-a-quelques-destinataires-pilote">plus bas</a>)</li>
</ul>
<p>En cas d'erreur, vous recevrez une erreur 400 détaillant le ou les problèmes,
qui peuvent notamment concerner les enregistrements
<a href="/#enregistrement-dkim">DKIM</a> et <a href="/#enregistrement-spf">SPF</a></p>
<pre class="prettyprint well"><code>HTTP 400 BAD REQUEST
{
    "sender_email": [
        "Le champ SPF pour example.com est mal configur\u00e9",
        "Pas de configuration DKIM pour le domaine example.com"
    ]
}
</code></pre>
<p>En cas d'erreur de validation, <strong>le message n'est pas créé</strong>.</p>
<p>Pour <em>modifier</em> le message , il faut effectuer une requête de type <code>PUT</code> à
l'adresse retournée dans l'attribut <strong>url</strong> en envoyant la totalité du contenu
de l'objet, modifié comme souhaité.</p>
<h3 id="a-propos-de-la-redaction-du-corps-html">À propos de la rédaction du corps HTML</h3>
<p>Si la méthode qui donne les meilleurs résultats est de rédiger ce document HTML
à la main, il peut également être produit avec un éditeur WYSIWYG, un traitement
de texte… etc.</p>
<p>Pour des conseils sur la rédaction de mails en HTML, vous pouvez vous référer à
<a href="http://kb.mailchimp.com/article/how-to-code-html-emails/">ce guide</a> ou encore
<a href="https://github.com/mailchimp/Email-Blueprints">ce dépôt d'exemples</a>.</p>
<h2 id="2-ajoutmodification-dune-liste-de-destinataires">2. Ajout/modification d'une liste de destinataires</h2>
<p>Il est possible d'ajouter des destinataires soit un par un, soit en lots :</p>
<p>(on utilise l'URL pointée par l'attribut <code>_links.message</code> de notre objet, voir
étape précédente).</p>
<h3 id="ajout-des-destinataires-un-par-un">Ajout des destinataires un par un</h3>
<p>Il suffit de faire autant de requêtes POST que de destinataires à ajouter.</p>
<pre class="prettyprint well"><code>POST /api/v1/mails/
{
    "to" : "mon-destinataire@domaine.tld",
    "message": "https://api.munchmail.net/api/v1/messages/4/"
}
</code></pre>
<h3 id="ajout-des-destinataires-par-lot">Ajout des destinataires par lot</h3>
<pre class="prettyprint well"><code>POST /api/v1/mails/
[
    {"to" : "john@domaine.tld",     "message": "https://api.munchmail.net/api/v1/messages/4/"},
    {"to" : "jane@domaine.tld",     "message": "https://api.munchmail.net/api/v1/messages/4/"},
    {"to" : "fox@autredomaine.tld", "message": "https://api.munchmail.net/api/v1/messages/4/"},
]
</code></pre>
<p>Que vous ajoutiez les destinataires individuellement ou en lot, vous recevrez
les statuts HTTP suivants :</p>
<ul>
<li><strong>201 (created)</strong> si tout se passe bien</li>
<li><strong>400 (bad request)</strong> si l'email est invalide (adresse mal formée ou domaine
non habilité à recevoir du courriel)</li>
</ul>
<p>Par exemple…</p>
<pre class="prettyprint well"><code> POST /api/v1/mails/
 {
    "to" : "jenesuispasunemail",
    "message": "https://api.munchmail.net/api/v1/messages/4/"
 }
</code></pre>
<p>… retournera</p>
<pre class="prettyprint well"><code>400 BAD REQUEST
{
    "to": [
       "Saisissez une adresse de courriel valide."
    ]
}
</code></pre>
<h2 id="3-previsualisation-et-envoi-a-quelques-destinataires-pilotes">3. Prévisualisation et envoi à quelques destinataires « pilotes »</h2>
<h3 id="previsualisation">Prévisualisation</h3>
<p>Une vue de validation est offerte sur les <code>messages</code> ; comme toutes les actions
liées aux ressources, son URL est proposée dans l'attribut <code>_links</code> ; celle-ci
l'est sous le nom <code>preview_send</code>.</p>
<p>On appelle la prévisualisation :</p>
<pre class="prettyprint well"><code>GET /api/v1/messages/4/preview/
</code></pre>
<p>… elle retourne :</p>
<pre class="prettyprint well"><code>HTTP 200 OK
{
    "recipients": [
        "mon-destinataire@domaine.tld",
        "john@domaine.tld",
        "fox@autre-domaine.tld"
    ],
    "excluded_recipients": [
        "jane@domaine.tld",
    ],
    "spam_score": 0.0,
    "is_spam": false,
    "html_message": "&lt;div&gt;&lt;body&gt;&lt;h1&gt;Mais ne marche pas sur mes chaussures en su\u00e9dine bleue&lt;/h1&gt;&lt;p style=\"font-size: small\"&gt;&lt;a href=\"UNSUBSCRIBE_URL\"&gt;Se d\u00e9sinscrire&lt;/a&gt; pour ne plus recevoir ces emails&lt;/p&gt;&lt;/body&gt;&lt;/div&gt;",
    "plaintext_message": "# Mais ne marche pas sur mes chaussures en su\u00e9dine bleue\n\n[Se d\u00e9sinscrire][1] pour ne plus recevoir ces emails\n\n   [1]: UNSUBSCRIBE_URL\n\n"
}
</code></pre>
<ul>
<li><strong>recipients</strong> et <strong>excluded_recipients</strong> se partagent les destinataires que
    vous avez définis à l'<a href="#2-ajoutmodification-dune-liste-de-destinataires">étape 2.</a>, dans excluded_recipients sont listés les
    destinataires auxquels la campagne ne sera pas envoyée pour des raisons de
    désinscription (<a href="/#desinscription-opt-out">résiliation</a>) de leur part ou des raisons techniques (<a href="/#bounce">bounces</a>).</li>
</ul>
<h3 id="envoi-a-quelques-destinataires-pilotes">Envoi à quelques destinataires pilotes</h3>
<p>À ce stade, vous pouvez envoyer votre message à un ou plusieurs destinataires
« pilotes », par exemple vous-même, des collègues, proches…</p>
<p>Cette étape peut vous servir, par exemple, à valider l'affichage de la campagne
sur différents webmails, terminaux mobiles…</p>
<p>Les mails générés seront identiques à ceux réellement envoyés à vos
destinataires, à ces exceptions près :</p>
<ul>
<li>le sujet sera préfixé par « <em>TEST</em> » ;</li>
<li>les liens de désinscription et d'abus pointeront vers des pages inactives ;</li>
<li>vous ne pourrez pas suivre l'état de livraison de ces emails.</li>
</ul>
<p>La requête est la suivante :</p>
<pre class="prettyprint well"><code>POST /api/v1/messages/1/preview_send/
{
   "to": "peter@example.com, steven@example.com"
}
</code></pre>
<h2 id="4-declenchement-de-lenvoi">4. Déclenchement de l'envoi</h2>
<p>Une fois que tout semble bon, il n'y a plus qu'à changer l'attribut <strong>status</strong>
du message à <em>sending</em>, par exemple à l'aide d'une requête <code>PATCH</code> (en ne
passant que l'attribut <em>status</em>):</p>
<pre class="prettyprint well"><code>PATCH /api/v1/campaigns/1/
{
    "status"       :"sending"
}
</code></pre>
<p>Si tout va bien, l'API retourne un <code>200 OK</code>.</p>
<p>Les mails commencent immédiatement à être envoyés aux destinataires, une
<a href="/#votre-compte-munchmail">notification</a> vous est envoyée, une seconde sera
envoyée à la fin du processus.</p>
<h2 id="5-suivi-des-envois">5. Suivi des envois</h2>
<h3 id="suivi-des-emails">Suivi des emails</h3>
<p>Vous pouvez avoir tous les emails en cours d'acheminement et utilisant
le lien <code>mails</code> de la campagne. Par exemple :</p>
<pre class="prettyprint well"><code>GET /api/v1/messages/4/mails/
{
    "count": 3,
    "next": "https://api.munchmail.fr/api/v1/mails/?page=2",
    "previous": null,
    "results": [
    {
        "url": "https://api.munchmail.net/api/v1/messages/4/mails/1/",
        "to": "jane@domain.tld",
        "date": "2014-08-05T12:44:28.556Z",
        "last_status": {
            "status": "sent",
            "date": "2014-08-05T12:59:11Z",
            "raw_msg": "Accepted by local MTA"
        },
        "message": "https://api.munchmail.net/api/v1/messages/4/",

    },
    {
        "url": "https://api.munchmail.net/api/v1/messages/4/mails/2/",
        "to": john@domain.tld",
        "date": "2014-07-25T08:52:34.261Z",
        "last_status": {
            "status": "delivered",
            "date": "2014-07-25T12:07:49Z",
            "raw_msg": Delivered to remote server"
        },
        "message": "https://api.munchmail.net/api/v1/messages/4/",
    },
    {
        "url": "https://api.munchmail.net/api/v1/messages/4/mails/3/",
        "to": "mon-destinataire@domaine.tld",
        "date": "2014-07-30T08:40:56Z",
        "last_status": {
            "status": "hardbounced",
            "date": "2014-07-30T08:41:44Z",
            "raw_msg": "recipient mon-destinataire@domain.tld do not exist"
        },
        "message": "https://api.munchmail.net/api/v1/messages/4/",
    }
    ]
}
</code></pre>
<p>Les différents statuts possibles sont :</p>
<ul>
<li><strong>unknown</strong> : le message n'est pas encore entré dans
    l'infrastructure mail</li>
<li><strong>sent</strong> : le message a été accepté par les serveurs d'oasiswork est en cours
    d'acheminement</li>
<li><strong>delivered</strong> : le message a été remis au serveur du destinataire</li>
<li><strong>softbounced</strong> : le message a été rejeté à plusieurs reprises,
    il n'a pu être remis.</li>
<li><strong>hardbounced</strong> : le message a été rejeté net par le serveur distant
    (hard-bounce).</li>
</ul>
<h3 id="suivi-des-resiliations">Suivi des résiliations</h3>
<p>Une <a href="/#votre-compte-munchmail">notification</a> est envoyée à chaque résiliation.</p>
<p>Par ailleurs, il est possible de consulter les résiliations via l'API ; si votre
identifiant de client est le 42 :</p>
<pre class="prettyprint well"><code>GET /api/v1/customers/42/opt_outs/

{
    "count": 2,
    "next": null,
    "previous": null,
    "results": [
        {
            "address": "jane-blacklist@example.com",
            "date": "2014-08-08T14:54:35Z",
            "origin": "mail",
            "campaign": null
        },
        {
            "address": "john-greylist@example.com",
            "date": "2014-08-08T14:55:16Z",
            "origin": "feedback-loop",
            "campaign": null
        },
    ]
}
</code></pre>
<p>Le champ <strong>origin</strong> contient la raison de la désinscription, qui peut-être
automatique ou bien volontaire de la part de l'utilisateur ; il peut contenir
les valeurs suivantes:</p>
<ul>
<li><strong>mail</strong> Un mail de désinscription a été envoyé à l'adresse <code>List-Unsubscribe</code>
    mentionnée dans un mail reçu par un de vos destinataires ;</li>
<li><strong>web</strong> Un destinataire a utilisé le formulaire du lien inséré en bas de
    l'email pour se désinscrire</li>
<li><strong>feedback-loop</strong> Le destinataire a marqué un de vos messages comme spam, et
    son hébergeur nous a remonté l'information</li>
<li><strong>bounce</strong> L'adresse du destinataire a produit trop d'erreurs de livraisons
    (ex: boite pleine, adresse inexistante…)</li>
<li><strong>abuse</strong> Le destinataire a signalé le message comme étant un abus</li>
</ul>
<p>Si vous recevez de nombreuses désinscriptions de type <strong>abuse</strong>, il faut vous
poser des question sur la légitimité de votre liste de
contacts. <strong>N'utilisez pas de liste de mails achetées</strong>… et respectez la
législation en vigueur.</p>
</div>
        </div>

        

        <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/prettify-1.0.min.js"></script>
        <script src="../../js/base.js"></script>
    </body>
</html>
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">

	<title>PHP - MunchMail</title>

        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">
        <link href="../../css/base.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <!-- Main title -->
            <a class="navbar-brand" href="../..">MunchMail</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            
            
                <li >
                    <a href="../..">Guide du développeur</a>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">L'API <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../../api/intro/">Introduction</a>
                        </li>
                    
                        <li >
                            <a href="../../api/auth/">Authentification & utilisateurs</a>
                        </li>
                    
                        <li >
                            <a href="../../api/tutoriel/">Tutoriel : un envoi de A à Z</a>
                        </li>
                    
                        <li >
                            <a href="../../api/categories/">Catégories</a>
                        </li>
                    
                        <li >
                            <a href="../../api/domaines/">Domaines</a>
                        </li>
                    
                        <li >
                            <a href="../../api/tracking/">Suivi des actions côté destinataire</a>
                        </li>
                    
                        <li >
                            <a href="../../api/mailmerge/">Publipostage</a>
                        </li>
                    
                        <li >
                            <a href="../../api/stats/">Statistiques</a>
                        </li>
                    
                        <li >
                            <a href="../../api/export/">Exports & formats</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Éditeur <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../../editeur/integration/">Intégration</a>
                        </li>
                    
                        <li >
                            <a href="../../editeur/creation-template/">Création de template</a>
                        </li>
                    
                        <li >
                            <a href="../../editeur/exemple/">Exemple</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li class="dropdown active">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Exemples de code <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li class="active">
                            <a href="./">PHP</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Infrastructure <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../../infra/requirements/">Besoins matériels</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li >
                    <a href="../../faq/">FAQ</a>
                </li>
            
            
            
                <li >
                    <a href="../../annexes/">Annexes</a>
                </li>
            
            
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                
                <li >
                    <a rel="next" href="../../editeur/exemple/">
                        <i class="fa fa-arrow-left"></i> Previous
                    </a>
                </li>
                <li >
                    <a rel="prev" href="../../infra/requirements/">
                        Next <i class="fa fa-arrow-right"></i>
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#php">PHP</a></li>
        
    
    </ul>
</div></div>
            <div class="col-md-9" role="main">

<h2 id="php">PHP</h2>
<pre><code>&lt;?php
// adapt it to your encoding, for ex ISO-8859-15
define(&quot;MY_ENCODING&quot;, &quot;UTF-8&quot;);

class HTTPException extends Exception {}

/** Class to handle encoding issues
 *
 * Otherwise, it will allow you to detect the current encoding of your
 * application and convert the data from/to API with the correct charsets.
 *
 * It helps dealing safely with json_encode and json_decode as they require utf8
 * in any case.
 * If you're sure your application is using utf-8, you can safely get rid of the
 * use of this class.
 */
class CharsetEncoder{
    public function __construct($internal_encoding) {
        $this-&gt;code_encoding = $internal_encoding;//mb_internal_encoding();
        $this-&gt;api_encoding = 'UTF-8';
        $this-&gt;need_transcoding = ($this-&gt;api_encoding != $this-&gt;code_encoding);
    }

    /** Converts the array to utf-8 if needed
     */
    public function array_to_api($array) {
        if ($this-&gt;need_transcoding) {
            $copy = unserialize(serialize($array));
            array_walk_recursive($copy, function(&amp;$val) {
                    if (is_string($val)) {
                        $val = mb_convert_encoding($val, $this-&gt;api_encoding,
                                                   $this-&gt;code_encoding);}
                });
            return $copy;
        } else {
            return $array;
        }
    }

    /** Converts the array from utf-8 if needed
     */
    public function array_from_api($array) {
        if ($this-&gt;need_transcoding) {
            $copy = unserialize(serialize($array));
            array_walk_recursive($copy, function(&amp;$val) {
                    if (is_string($val)) {
                        $val = mb_convert_encoding($val, $this-&gt;code_encoding,
                                                   $this-&gt;api_encoding);}
                    }
                });
            return $copy;
                } else {
            return $array;
        }
    }
};


/** Classe utilitaire pour accéder à l'API
 *
 * Utilise php5-curl (il est donc nécessaire de l'installer).
 * $api_key : clef d'API
 */
class HTTPClient{

    private $ch;
    private $base_options;

    public function __construct($api_key) {
        $this-&gt;base_options = array(
          CURLOPT_RETURNTRANSFER =&gt; true,
          CURLOPT_FOLLOWLOCATION =&gt; true,
          CURLOPT_USERPWD        =&gt; 'api:'.$api_key,
          CURLOPT_HTTPHEADER     =&gt; array('Content-Type: application/json')
        );
        $this-&gt;ch = curl_init();
        $this-&gt;encoder = new CharsetEncoder(MY_ENCODING);
    }

    /** Handles an HTTP response, throws exception if Error
     *
     * @param $ok_statuses an array of acceptable statuses, if the return
     *                     code is not within this list, an exception is
     *                     raised.
     * @param $out         the output, as string
     * @returns            a structured PHP object (decoded from JSON)
     **/
    private function handle_return($out, $ok_statuses) {
        if ($out === false) {
            throw new HTTPException(curl_error($this-&gt;ch));
        } else {
            $http_status = curl_getinfo($this-&gt;ch, CURLINFO_HTTP_CODE);
            if (! in_array($http_status, $ok_statuses)) {
                throw new HTTPException('HTTP '.$http_status.': '.$out);
            }
            return json_decode($out);
        }
    }

    /** Issue a request to the api
     *
     * @param $reqtype the HTTP verb (GET, PUT...)
     * @param $data    relevant for PUT/PATCH/POST : data, as structured PHP
     *                 object
     */
    public function req($reqtype, $url, $data=NULL) {
        if ($data) {$data = $this-&gt;encoder-&gt;array_to_api($data)};
        $json_data = json_encode($data);
        $req_opts = array(CURLOPT_URL            =&gt; $url,
                          CURLOPT_CUSTOMREQUEST  =&gt; $reqtype,
                          CURLOPT_POSTFIELDS     =&gt; $json_data);
        curl_setopt_array($this-&gt;ch, $req_opts + $this-&gt;base_options);
        $out = curl_exec($this-&gt;ch);
        return $this-&gt;encoder-&gt;array_from_api($this-&gt;handle_return($out, array(200, 201)));
    }

    // shortcuts to HTTP methods
    public function delete($url)       {return $this-&gt;req('DELETE', $url);}
    public function get($url)          {return $this-&gt;req('GET', $url);}
    public function patch($url, $data) {return $this-&gt;req('PATCH', $url, $data);}
    public function post($url, $data)  {return $this-&gt;req('POST', $url, $data);}
    public function put($url, $data)   {return $this-&gt;req('PUT', $url, $data);}
}


/************************
 * Déroulé de l'exemple *
 ************************/

// Paramètres

$base_url = 'https://api.munchmail.net/v1';
$client_url = $base_url.'/customers/42/';
$api_key = 'key-xxxxxxxxxxxxx'

// Initialisation du client HTTP
$client = new HTTPClient($api_key);

// Récupération des informations client
$customer = $client-&gt;get($client_url);

echo &quot;**** Ajout d'un domaine\n&quot;;

$domains_url = $base_url.'/domains/';

try {
  $domain = $client-&gt;post($domains_url, array('name'=&gt; 'sandbox.munchmail.net'));
  if (($domain-&gt;spf_status == 'ok') &amp;&amp;
      ($domain-&gt;dkim_status == 'ok') &amp;&amp;
      ($domain-&gt;mx_status == 'ok')) {
      print_r($domain);
    printf('Domaine %s bien configuré\n');
  } else {
    printf('Domaine %s mal configuré\n');
    die();
  }

} catch (HTTPException $e) {
  echo 'Error creating the domain, maybe it already exists';
}




echo &quot;**** Création d'un message\n&quot;;

$messages_url = $base_url.'/messages/';
$message = $client-&gt;post($messages_url, array(
  'name'         =&gt; 'Newsletter de Juillet',
  'sender_email' =&gt; 'newsletter@sandbox.example.com',
  'sender_name'  =&gt; 'Communication ACME chaussures',
  'subject'      =&gt;  &quot;Tu peux faire tout ce que tu veux&quot;,
  'html'  =&gt; &quot;&lt;h1&gt;Mais ne marche pas sur mes chaussures en suédine bleue&lt;/h1&gt;&quot;,
));


print_r($message);

// Vérification du niveau de spam.
if ($message-&gt;is_spam) {
    printf(&quot;SPAM ! (score: %d)\n&quot;, $message-&gt;spam_score);
 } else {
    printf(&quot;pas spam (score: %d)\n&quot;, $message-&gt;spam_score);
}

// Ajout des destinataires individuellement…
$mails_url = $base_url.'/mails/';

$client-&gt;post($mails_url, array(&quot;to&quot;=&gt;&quot;solo@domaine.tld&quot;,
                &quot;message&quot;=&gt;$message-&gt;url));

// ou par lot…

$client-&gt;post($mails_url, array(
  array(&quot;to&quot;=&gt;&quot;john@domaine.tld&quot;, &quot;message&quot;=&gt; $message-&gt;url),
  array(&quot;to&quot;=&gt;&quot;jane@domain.tld&quot;, &quot;message&quot;=&gt; $message-&gt;url),
  array(&quot;to&quot;=&gt;&quot;fox@autredomaine.tld&quot;, &quot;message&quot;=&gt; $message-&gt;url)));

// Récupération de tous les destinataires

echo &quot;**** Destinataires\n&quot;;
print_r($client-&gt;get($message-&gt;_links-&gt;mails-&gt;href));

echo &quot;**** Preview du message\n&quot;;
print_r($client-&gt;get($message-&gt;_links-&gt;preview-&gt;href));

// Envoi

print_r($client-&gt;patch($message-&gt;url, array(&quot;status&quot;=&gt;&quot;sending&quot;)));

// Consultation des optout

echo &quot;**** Consultation des opt-outs\n&quot;;
print_r($client-&gt;get($customer-&gt;_links-&gt;opt_outs-&gt;href));

?&gt;
</code></pre></div>
        </div>

        

        <script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script>
        <script src="../../js/base.js"></script>
    </body>
</html>
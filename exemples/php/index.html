<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">

        <title>PHP - MunchMail</title>

        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link href="../../css/prettify-1.0.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <!-- Main title -->
            <a class="navbar-brand" href="../..">MunchMail</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            
            
                <li >
                    <a href="../..">Guide du développeur</a>
                </li>
            
            
            
                <li >
                    <a href="../../api/">L'API</a>
                </li>
            
            
            
                <li class="dropdown active">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Exemples de code <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li class="active">
                            <a href="./">PHP</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li >
                    <a href="../../demonstration/">Instance de démonstration</a>
                </li>
            
            
            
                <li >
                    <a href="../../faq/">FAQ</a>
                </li>
            
            
            
                <li >
                    <a href="../../annexes/">Annexes</a>
                </li>
            
            
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                
                <li >
                    <a rel="next" href="../../api/">
                        <i class="fa fa-arrow-left"></i> Previous
                    </a>
                </li>
                <li >
                    <a rel="prev" href="../../demonstration/">
                        Next <i class="fa fa-arrow-right"></i>
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#php">PHP</a></li>
        
    
    </ul>
</div></div>
            <div class="col-md-9" role="main">

<h2 id="php">PHP</h2>
<pre class="prettyprint well"><code>&lt;?php
class HTTPException extends Exception {}

class HTTPSClient{
    /** Classe utilitaire pour accéder à l'API

        Utilise php5-curl (il est donc nécessaire de l'installer).

        $cert_file     : chemin vers le fichier de certificat client
        $ca_file       : chemin vers le certificat du serveur oasiswork
        $cert_password : mot de passe du certificat client
     */

    private $ch;
    private $base_options;

    public function __construct($cert_file, $ca_file, $cert_password) {
        $this-&gt;base_options = array(
          CURLOPT_RETURNTRANSFER =&gt; true,
          CURLOPT_FOLLOWLOCATION =&gt; true,
          CURLOPT_CAINFO         =&gt; $ca_file,
          CURLOPT_SSLCERT        =&gt; $cert_file,
          CURLOPT_SSLCERTPASSWD  =&gt; $cert_password,
          CURLOPT_HTTPHEADER     =&gt; array('Content-Type: application/json')
        );
        $this-&gt;ch = curl_init();
    }

    private function handle_return($out, $ok_statuses) {
        if ($out === false) {
            throw new HTTPException(curl_error($this-&gt;ch));
        } else {
            $http_status = curl_getinfo($this-&gt;ch, CURLINFO_HTTP_CODE);
            if (! in_array($http_status, $ok_statuses)) {
                throw new HTTPException('HTTP '.$http_status.': '.$out);
            }
            return json_decode($out);
        }
    }

    public function req($reqtype, $url, $data=NULL) {
        $req_opts = array(CURLOPT_URL            =&gt; $url,
                          CURLOPT_CUSTOMREQUEST  =&gt; $reqtype,
                          CURLOPT_POSTFIELDS     =&gt; json_encode($data));
        curl_setopt_array($this-&gt;ch, $req_opts + $this-&gt;base_options);
        $out = curl_exec($this-&gt;ch);
        return $this-&gt;handle_return($out, array(200, 201));
    }

    // shortcuts to HTTP methods
    public function delete($url)       {return $this-&gt;req('DELETE', $url);}
    public function get($url)          {return $this-&gt;req('GET', $url);}
    public function patch($url, $data) {return $this-&gt;req('PATCH', $url, $data);}
    public function post($url, $data)  {return $this-&gt;req('POST', $url, $data);}
    public function put($url, $data)   {return $this-&gt;req('PUT', $url, $data);}
}


/************************
 * Déroulé de l'exemple *
 ************************/

// Paramètres
$ca_file = 'docs/files/ssl/demo-ca.pem';
$cert_file = 'docs/files/ssl/demo-client-cert.pem';
$cert_pass = 'OHc9HS7qOynty8LiH5tNV0qKX';
$client_url = 'https://demo.munchmail.net/api/v1/customers/42/';

// Initialisation du client HTTP
$client = new HTTPSClient($cert_file, $ca_file, $cert_pass);

// Récupération des informations client
$customer = $client-&gt;get($client_url);

// Création d'une campagne
$campaigns_url = 'https://localhost:4243/api/v1/campaigns/';
$campaign = $client-&gt;post($campaigns_url, array(
  'name'         =&gt; 'Newsletter de Juillet',
  'sender_email' =&gt; 'newsletter@example.com',
  'sender_name'  =&gt; 'Communication ACME chaussures',
  'tech_contacts'=&gt; 'admins@example.com, communication@example.com',
  'owners'       =&gt; 'communication@example.com',
  'customer'     =&gt; 42));


echo &quot;**** Détails de la campagne\n&quot;;

print_r($campaign);

// Définition du message de la campagne
$message = $client-&gt;put($campaign-&gt;message,
                        array('subject' =&gt; 'Mon subjet',
                              'html'    =&gt; '&lt;h1&gt;Hello world&lt;/h1&gt;'));

// Vérification du niveau de spam.
if ($message-&gt;is_spam) {
    printf(&quot;SPAM ! (score: %d)\n&quot;, $message-&gt;spam_score);
 } else {
    printf(&quot;pas spam (score: %d)\n&quot;, $message-&gt;spam_score);
}

// Ajout des destinataires individuellement…

$client-&gt;post($campaign-&gt;mails, array(&quot;to&quot;=&gt;&quot;solo@domaine.tld&quot;));


// ou par lot…

$client-&gt;post($campaign-&gt;mails, array(
                                      array(&quot;to&quot;=&gt;&quot;john@domaine.tld&quot;),
                                      array(&quot;to&quot;=&gt;&quot;jane@domain.tld&quot;),
                                      array(&quot;to&quot;=&gt;&quot;fox@autredomaine.tld&quot;)));

// Récupération de tous les destinataires

echo &quot;**** Destinataires\n&quot;;
print_r($client-&gt;get($campaign-&gt;mails));

echo &quot;**** Preview de la campagne\n&quot;;
print_r($client-&gt;get($campaign-&gt;preview));

// Envoi

print_r($client-&gt;patch($campaign-&gt;url, array(&quot;status&quot;=&gt;&quot;sending&quot;)));

// Consultation des optout

echo &quot;**** Consultation des opt-outs\n&quot;;
print_r($client-&gt;get($customer-&gt;opt_outs));

?&gt;
</code></pre>

</div>
        </div>

        

        <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/prettify-1.0.min.js"></script>
        <script src="../../js/base.js"></script>
    </body>
</html>